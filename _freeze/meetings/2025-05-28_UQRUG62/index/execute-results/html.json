{
  "hash": "3d302ff164a4d1587977ec9cca10c33a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: UQRUG 62\ndraft: false\neditor: visual\ndate: '2025-05-28'\ndescription: '**Overview**: profvis<br /> **Questions**: tidyr, dplyr, tmap.mapgl, maplibre, stata, spss'\ncategories: meeting\ntoc: true\ntoc-depth: 5\necho: true\neval: false\n---\n\n\n\n## Topic: code profiling with profvis\n\n-   Profvis website: <https://profvis.r-lib.org/>\n-   How to use it in RStudio: <https://support.posit.co/hc/en-us/articles/218221837-Profiling-R-code-with-the-RStudio-IDE#using-the-flame-graph>\n\nSample code to test:\n\n``` R\n# example dataset from ggplot2\nlibrary(ggplot2)\ndiamonds\n\n# function to convert diamond price from USD to AUD\nusd_to_aud <- function (x) {\n  Sys.sleep(0.02) # wait a little, so our problem is more obvious later on\n  x * 1.55\n}\n\n# process our data\nlibrary(dplyr)\ndiamonds |> \n  # filter out cheaper diamonds\n  filter(price > 500) |>\n  # sort by carat\n  arrange(carat) |> \n  # how big is each carat group?\n  group_by(carat) |> \n  mutate(carat_group_size = n()) |>\n  # convert price to AUD\n  mutate(price = usd_to_aud(price))\n```\n\nThe last block of code is very slow! Why is that?\n\nLet's use profiling to find out! In RStudio:\n\n-   use the menu \"Profile - Start profiling\"\n\n-   run the problematic block of code\n\n-   click \"Stop profiling\" above the console\n\nA new \"Profile 1\" tab should open with two types of visualisation of your code's performance:\n\n-   A Flame Graph tab\n\n-   A Data tab\n\nUse them to spot the processes that use most of the time.\n\nYou can also use the profvis package directly by wrapping the code into the `profvis()` function:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(profvis)\nprofvis({\n  diamonds |> \n    # filter out cheaper diamonds\n    filter(price > 500) |>\n    # sort by carat\n    arrange(carat) |> \n    # how big is each carat group?\n    group_by(carat) |> \n    mutate(carat_group_size = n()) |>\n    # convert price to AUD\n    mutate(price = usd_to_aud(price))\n})\n```\n:::\n\n\n\nLooks like our custom function takes most of the time, and is executed several times! The issue is that we didn't ungroup after the first mutate, and therefore the second mutate is unnecessarily split between groups instead of running once on the whole column.\n\nFix it with an `ungroup()` step and compare the time it takes to execute:\n\n``` R\nprofvis({\n  diamonds |> \n    # filter out cheaper diamonds\n    filter(price > 500) |>\n    # sort by carat\n    arrange(carat) |> \n    # how big is each carat group?\n    group_by(carat) |> \n    mutate(carat_group_size = n()) |>\n    # remove grouping now that we don't need it!\n    ungroup() |> \n    # convert price to AUD\n    mutate(price = usd_to_aud(price))\n})\n```\n\n## Attendees\n\n| Name            | Where are you from?   | What brings you here?    |\n|-----------------|-----------------------|--------------------------|\n| Thi Quynh Chang | student               | learn R tips             |\n| Catherine       | UQ/QUT                | profvis                  |\n| Haileyesus      | HDR student at Gatton |                          |\n| Tianti          | HDR student at Gatton |                          |\n| Aprezo          |                       |                          |\n| Rodrigo         | HDR at SAFS           |                          |\n| Lamees          |                       |                          |\n| St√©phane        | Library               | Here to help and present |\n\n## Questions and shared resources\n\n### Does the computer go to sleep while executing code that takes ages?\n\n-   RStudio should inhibit sleep until finished (as *should* any app that executes code)\n\n<!-- -->\n\n-   But we can change power saving options in OS settings, to be extra sure (if the computer is sleeping, computation is halted and only resumes once waking it up).\n\n<!-- -->\n\n-   We can use the {tictoc} package, and its tic() and toc() functions to time a process (or profvis):\n\n``` R\n# time script\nlibrary(tictoc)\ntic()\ndiamonds |> \n  # filter out cheaper diamonds\n  filter(price > 500) |>\n  # sort by carat\n  arrange(carat) |> \n  # how big is each carat group?\n  group_by(carat) |> \n  mutate(carat_group_size = n()) |>\n  # convert price to AUD\n  mutate(price = usd_to_aud(price))\ntoc()\n```\n\n### Is `group_by()` similar to `reshape()` ?\n\nBase R's reshape() is equivalent to `pivot_longer()` and `pivot_wider()`, from the package {tidyr}, in the Tidyverse. See <https://rstudio.github.io/cheatsheets/tidyr.pdf> for a visual of what they do\n\nOn the other hand, `group_by()` changes the scope of operation (for example, summarising per group rather than the whole dataset).\n\n``` R\n# summarise whole column to single value\ndiamonds |> \n  summarise(mean(price))\n\n# summarise per group:\ndiamonds |> \n  group_by(color) |> \n  summarise(mean(price))\n\n# group by two variables\ndiamonds |> \n  group_by(color, cut) |> \n  summarise(mean(price))\n# \"peels off\" the last grouping at each summarising operation\n```\n\n### Transitioning from SPSS and Stata to R\n\nThe {haven} package is useful for importing data from both SPSS and Stata.\n\nRecommended resources to get started:\n\n-   Library courses! <https://web.library.uq.edu.au/study-and-learning-support/training-and-workshops/online-and-person-workshops>\n\n<!-- -->\n\n-   If you can't make it, here's the Heatmaps session recording: <https://www.youtube.com/watch?v=V-IRkO4NIHU>\n\n-   *R Graphics Cookbook*: <https://r-graphics.org/>\n\n<!-- -->\n\n-   *R 4 Data Science* book: <https://r4ds.hadley.nz/>\n\n<!-- -->\n\n-   *Data Visualization with R*, course by Andrew Weiss: <https://datavizf24.classes.andrewheiss.com/>\n\n### Interactive 3D map with tmap.mapgl\n\nFor a bit of fun, example of getting data from OSM and rendering 3D buildings with a {tmap} extension that makes use of the maplibre library:\n\n``` R\n# get vector buildings for UQ, St Lucia\nlibrary(osmdata)\nbuildings <- opq(bbox = \"UQ, St Lucia\") |>\n  add_osm_feature(key = \"building\") |>\n  osmdata_sf()\n\nlibrary(dplyr)\n# only keep polygons\nbuildings_poly <- buildings$osm_polygons |>\n  # convert height and levels from string to numeric\n  mutate(levels = as.numeric(`building:levels`),\n         # if height column does not exist, fill it with NA\n         height = if (\"height\" %in% colnames(buildings$osm_polygons)) as.numeric(height) else NA_real_) |>\n  # assume 2 levels if NA\n  mutate(levels = if_else(is.na(levels), 2, levels),\n         # assume height of 3 m per level if no height\n         height = if_else(is.na(height), levels * 3, height))\n\n# visualise\nlibrary(tmap)\nlibrary(tmap.mapgl)\ntmap_mode(\"maplibre\")\ntm_shape(buildings_poly) +\n  tm_polygons_3d(height = \"height\",\n                 options = opt_tm_polygons_3d(\n                   height.max = max(buildings_poly$height))\n                 ) +\n  tm_maplibre(pitch = 45)\n```\n\n![Static screenshot the interactive map](images/clipboard-2753904182.png){fig-alt=\"angle view of grey 3D buildings laid on top of an OSM basemap, showing UQ's St Lucia campus\"}\n\n## Shared resources\n\nResources shared during the meeting.\n\n-   Hacky Hour, 3-4 pm every Tuesday (online)\n\n    -   <https://rcc.uq.edu.au/training-support/meetups>\n\n    -   ask us for the Zoom link!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}