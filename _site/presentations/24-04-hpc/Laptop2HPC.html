<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr David Green, UQ Research Computing Centre">
<meta name="dcterms.date" content="2024-08-20">

<title>From Laptop to HPC – UQRUG</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/uqrug_fav.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6e5a5027aec1b096cef8c6d9f890f2df.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-cff3dccb75276adba07613a0a9f3573c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-6e5a5027aec1b096cef8c6d9f890f2df.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="From Laptop to HPC – UQRUG">
<meta property="og:description" content="The University of Queensland R Users Group">
<meta property="og:image" content="images/uqrug_og.png">
<meta property="og:site_name" content="UQRUG">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/uqrug.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">UQRUG</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../events.html"> 
<span class="menu-text">Events</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pastmeetings.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../community.html"> 
<span class="menu-text">Community</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code_of_conduct.html"> 
<span class="menu-text">Code of Conduct</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/UQRUG/uqrug_website" title="" class="quarto-navigation-tool px-1" aria-label="github"><i class="bi bi-github"></i></a>
    <a href="https://pad.education/p/uqrug" title="" class="quarto-navigation-tool px-1" aria-label="Collaborative Document"><i class="bi bi-file-earmark-text"></i></a>
    <a href="https://www.youtube.com/@UQRUG" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-youtube"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a>
  <ul class="collapse">
  <li><a href="#your-r-code" id="toc-your-r-code" class="nav-link" data-scroll-target="#your-r-code">Your R code</a></li>
  <li><a href="#laptop-limitations" id="toc-laptop-limitations" class="nav-link" data-scroll-target="#laptop-limitations">Laptop limitations</a></li>
  <li><a href="#enter-bunya-for-comparison" id="toc-enter-bunya-for-comparison" class="nav-link" data-scroll-target="#enter-bunya-for-comparison">Enter Bunya, for comparison</a></li>
  <li><a href="#hpc-101" id="toc-hpc-101" class="nav-link" data-scroll-target="#hpc-101">HPC 101</a></li>
  <li><a href="#the-implications-for-your-r-code" id="toc-the-implications-for-your-r-code" class="nav-link" data-scroll-target="#the-implications-for-your-r-code">The implications for your R code</a></li>
  <li><a href="#using-r-on-bunya" id="toc-using-r-on-bunya" class="nav-link" data-scroll-target="#using-r-on-bunya">Using R on Bunya</a></li>
  <li><a href="#access-methods-for-r" id="toc-access-methods-for-r" class="nav-link" data-scroll-target="#access-methods-for-r">Access Methods for R</a></li>
  <li><a href="#parameter-sweeps" id="toc-parameter-sweeps" class="nav-link" data-scroll-target="#parameter-sweeps">Parameter Sweeps</a></li>
  </ul></li>
  <li><a href="#in-summary" id="toc-in-summary" class="nav-link" data-scroll-target="#in-summary">In summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">From Laptop to HPC</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dr David Green, UQ Research Computing Centre </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- https://bootswatch.com/ -->
<!-- bootswatch:  default _minty_  celurean solar cyborg  quartz  zephyr   -->
<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
<p>In this session, we will trace the steps taken by the many UQ researchers using R who have wanted, or needed, stronger (or more numerous) computers on which to run their codes.</p>
<p>There are tremendous benefits to porting your R computations to the high-performance computing (HPC) environment.</p>
<p>But there are also some obstacles to overcome, especially with the ease of use and there are a few gotchas.</p>
<p>Some recent innovations on the Bunya HPC system are addressing some of those obstacles.</p>
</section>
<section id="outline" class="level2">
<h2 class="anchored" data-anchor-id="outline">Outline</h2>
<ul>
<li>So you’ve got some R code running on your laptop and you’ve hit limits?</li>
<li>HPC 101</li>
<li>Implications for your code</li>
<li>R on Bunya</li>
<li>Access Modes</li>
<li>Parameter Sweeps</li>
</ul>
<section id="your-r-code" class="level3">
<h3 class="anchored" data-anchor-id="your-r-code">Your R code</h3>
<p>Imagine the scenario where your R code</p>
<ul>
<li>Is showing promise,</li>
<li>Needs to be run more extensively,</li>
<li>Is already hitting limits when running on your laptop.</li>
</ul>
</section>
<section id="laptop-limitations" class="level3">
<h3 class="anchored" data-anchor-id="laptop-limitations">Laptop limitations</h3>
<ul>
<li>Code could run faster with more cores,</li>
<li>Insufficient RAM,</li>
<li>Disk space is small,</li>
<li>The laptop is unusable for other work,</li>
<li>Smoke comes out when it’s running your code ;-)</li>
</ul>
</section>
<section id="enter-bunya-for-comparison" class="level3">
<h3 class="anchored" data-anchor-id="enter-bunya-for-comparison">Enter Bunya, for comparison</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 19%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">This Laptop</th>
<th style="text-align: center;">Bunya Phase 1</th>
<th style="text-align: center;">Bunya Phase 2</th>
<th>Bunya Phase 3 soon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CPU</td>
<td style="text-align: center;">Intel Core i7-8650U</td>
<td style="text-align: center;">AMD EPYC 7643 (Milan)</td>
<td style="text-align: center;">AMD EPYC 9454 (Genoa)</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">Speed</td>
<td style="text-align: center;">2.11 GHz</td>
<td style="text-align: center;">2.30 GHz</td>
<td style="text-align: center;">2.75 GHz</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sockets</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">Cores</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">96</td>
<td style="text-align: center;">96</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Logical Processors</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">192</td>
<td style="text-align: center;">192</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">RAM</td>
<td style="text-align: center;">16 GB</td>
<td style="text-align: center;">2.0 TB</td>
<td style="text-align: center;">1.5 TB</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of Devices</td>
<td style="text-align: center;">1 (usually)</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">33</td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">Total number of cores</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">5760</td>
<td style="text-align: center;">3168</td>
<td></td>
</tr>
</tbody>
</table>
<section id="and-thats-not-all-of-bunya" class="level4">
<h4 class="anchored" data-anchor-id="and-thats-not-all-of-bunya">And that’s not all of Bunya !!</h4>
<ul>
<li>Some Bunya nodes have 4TB.</li>
<li>Several other Phase 2 nodes have state-of-art GPU computing capabilities.</li>
<li>R has limited support for GPU</li>
<li>See <a href="https://cran.r-project.org/web/packages/GPUmatrix/index.html">gpuMatrix</a> package, for example.</li>
</ul>
</section>
</section>
<section id="hpc-101" class="level3">
<h3 class="anchored" data-anchor-id="hpc-101">HPC 101</h3>
<ul>
<li>HPCs are built for speed, not for comfort !</li>
<li>HPCs are almost always a command line linux platform.</li>
<li>HPCs are almost always batch mode environments.</li>
<li>Job scripts are created and submitted to the batch system.</li>
<li>Jobs need to be able to run “with the lights out”.</li>
<li>Jobs need to be able to run without user intervention.</li>
<li>Many HPCs (including Bunya) support interactive use via the batch system.</li>
<li>Some HPCs (including Bunya) have graphical capabilities for user access.</li>
<li>Some HPCs (not Bunya) are based on the Windows operating system.</li>
</ul>
<section id="structure-of-bunya-hpc" class="level4">
<h4 class="anchored" data-anchor-id="structure-of-bunya-hpc">Structure of Bunya HPC</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/UQ-RCC/hpc-docs/blob/main/media/HPC_Cluster_Schematic.png?raw=true" class="img-fluid figure-img"></p>
<figcaption>Schematic of a HPC Cluster</figcaption>
</figure>
</div>
</section>
<section id="the-vast-majority-of-work-on-hpcs-is-done-via-a-batch-system" class="level4">
<h4 class="anchored" data-anchor-id="the-vast-majority-of-work-on-hpcs-is-done-via-a-batch-system">The vast majority of work on HPCs is done via a batch system</h4>
<pre><code>#There are this many jobs running
[davidg@bunya1 ~]$ squeue | grep " R " | wc -l
801

#and this many are queued
[davidg@bunya1 ~]$ squeue | grep " PD " | wc -l
470</code></pre>
<p>We often want to know how busy Bunya is. The <code>sinfo</code> command tells us the state of all the nodes in a partition.</p>
<pre><code>[davidg@bunya1 ~]$ sinfo -p general
PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
general      up 14-00:00:0      1  down$ bun009
general      up 14-00:00:0      1  drain bun023
general      up 14-00:00:0     39    mix bun[008,010-011,026,034,045-050,060,062,083-086,088,090,092-095,097,099-105,108-115]
general      up 14-00:00:0     54  alloc bun[006-007,012-022,024-025,027-033,035-044,051-059,061,063-067,087,089,091,096,098,106-107]


[davidg@bunya1 ~]$ sinfo -p gpu_cuda
PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
gpu_cuda     up 7-00:00:00      1  down$ bun003
gpu_cuda     up 7-00:00:00     16    mix bun[004-005,068,071-082,116]</code></pre>
<p>The node states will usually be one of</p>
<ul>
<li>idle (no jobs),</li>
<li>mix (mixed, some space left for new jobs),</li>
<li>alloc (fully allocated),</li>
<li>drain (emptying, usually for maintenance),</li>
<li>down (faulty or down for maintenance)</li>
</ul>
</section>
<section id="there-is-the-possibility-of-interactive-use-but" class="level4">
<h4 class="anchored" data-anchor-id="there-is-the-possibility-of-interactive-use-but">There is the possibility of interactive use BUT …</h4>
<p>Interactive use <em>must</em> still be mediated by the batch system to fairly share the resources.</p>
<p>This ensures that the computation takes place on a compute nodes.</p>
<p>Installing R packages must <em>not</em> be done on the login nodes. Getting in early ;-)</p>
<p>Interactive graphical usage of R can be achieved using</p>
<ul>
<li>interactive command line jobs with X11 forwarding enabled</li>
<li>Bunya-on-demand via a web browser</li>
</ul>
<p>So, yes, you can run RStudio. Indeed, <em>two</em> ways!</p>
</section>
</section>
<section id="the-implications-for-your-r-code" class="level3">
<h3 class="anchored" data-anchor-id="the-implications-for-your-r-code">The implications for your R code</h3>
<p>Some of the benefits of moving to HPC are access to potentially</p>
<ul>
<li>thousands of CPU cores,</li>
<li>terabytes of RAM,</li>
<li>fast temporary disk for large data sets,</li>
<li>ease of use of RDM storage for archiving data.</li>
</ul>
<p>Some of the challenges:</p>
<ul>
<li>managing your source code across platforms</li>
<li>modifications for locations</li>
<li>locating R software and pre-built libraries</li>
<li>handling the different CPU architectures</li>
<li>letting go of the notion of an all encompassing R script</li>
</ul>
</section>
<section id="using-r-on-bunya" class="level3">
<h3 class="anchored" data-anchor-id="using-r-on-bunya">Using R on Bunya</h3>
<ul>
<li>There is a great deal of software installed on Bunya.</li>
<li>You just need to be able to find it!</li>
<li>Environment modules (based on lmod) does all the “dirty work”.</li>
<li>You can activate/deactivate access to installed software.</li>
<li>The central installations of R will have LOTS of “extensions” (R packages).</li>
<li>If you need some exotic R package, you are able to install it yourself.</li>
</ul>
<section id="how-to-activate-r-in-your-session" class="level4">
<h4 class="anchored" data-anchor-id="how-to-activate-r-in-your-session">How to activate R in your session</h4>
<pre><code>[uqdgree5@bun048 R]$ module purge

[uqdgree5@bun048 R]$ module load r/4.3.3-gfbf-2023a

[uqdgree5@bun048 R]$ which Rscript
/sw/auto/rocky8c/epyc3/software/R/4.3.3-gfbf-2023a/bin/Rscript

[uqdgree5@bun048 R]$ cat demo.R
1+1
2+2
[uqdgree5@bun048 R]$

[uqdgree5@bun048 R]$ Rscript demo.R
[1] 2
[1] 4</code></pre>
</section>
<section id="where-is-it-going-to-search-for-r-packages" class="level4">
<h4 class="anchored" data-anchor-id="where-is-it-going-to-search-for-r-packages">Where is it going to search for R packages?</h4>
<pre><code>[uqdgree5@bun048 R]$ module purge

[uqdgree5@bun048 R]$ module load r/4.2.1-foss-2022a

[uqdgree5@bun048 R]$ which R
/sw/auto/rocky8c/epyc3/software/R/4.2.1-foss-2022a/bin/R

[uqdgree5@bun048 R]$ R

R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

&gt; .libPaths()
[1] "/home/uqdgree5/R/x86_64-pc-linux-gnu-library/4.2"
[2] "/sw/auto/rocky8c/epyc3/software/R/4.2.1-foss-2022a/lib64/R/library"
&gt; q()
Save workspace image? [y/n/c]: n</code></pre>
</section>
<section id="remember-mention-of-epyc3-and-epyc4-cpus" class="level4">
<h4 class="anchored" data-anchor-id="remember-mention-of-epyc3-and-epyc4-cpus">Remember mention of EPYC3 and EPYC4 CPUs ?</h4>
<ul>
<li>You can build additional R packages if you need them.</li>
<li>They install into your <code>R</code> folder in your home directory.</li>
<li>An R package built on an EPYC3 node will work on EPYC3 and EPYC4.</li>
<li>An R package built on an EPYC4 node will only work on EPYC4.</li>
</ul>
</section>
<section id="you-dont-need-to-re-build-any-of-the-following-packages" class="level4">
<h4 class="anchored" data-anchor-id="you-dont-need-to-re-build-any-of-the-following-packages">You don’t need to re-build any of the following packages</h4>
<ul>
<li>They have been built separately on EPYC3 and EPC4 nodes.</li>
<li>It will save you disk quota and time if you don’t re-build them.</li>
<li>Be careful <em>not</em> to reset your <code>.libPaths()</code> and ignore these.</li>
<li>There are almost 1200 popular R packages pre-installed with the R Version 4.2.1 installation on Bunya.</li>
</ul>
<pre><code>[davidg@bunya1 ~]$ ls /sw/auto/rocky8c/epyc3/software/R/4.2.1-foss-2022a/lib64/R/library
abc                   doMC                ineq                      parallelly          scatterplot3d
abc.data              doParallel          influenceR                parallelMap         scs
abe                   doRNG               infotheo                  ParamHelpers        sctransform
abind                 doSNOW              ini                       parsedate           SDMTools
acepack               dotCall64           inline                    party               seewave
adabag                downloader          intergraph                partykit            segmented
ade4                  dplyr               interpretR                pastecs             selectr
ADGofTest             dr                  intrinsicDimension        patchwork           sem
admisc                drgee               inum                      pbapply             semPLS
aggregation           DRR                 ipred                     pbivnorm            semTools
AICcmodavg            drugCombo           irace                     pbkrtest            sendmailR</code></pre>
<pre><code>&lt;SNIP&gt;                &lt;SNIP&gt;              &lt;SNIP&gt;                    &lt;SNIP&gt;              &lt;SNIP&gt;</code></pre>
<pre><code>dismo                 HWxtest             origami                   Rvmmin              xtable
distillery            hypergeo            orthopolynom              RWeka               xts
distr                 ica                 osqp                      RWekajars           yaImpute
distrEx               IDPmisc             outliers                  s2                  yaml
distributional        idr                 packrat                   sampling            yulab.utils
DistributionUtils     ids                 pacman                    sandwich            zeallot
diveRsity             ie2misc             pammtools                 sass                zip
dlm                   igraph              pamr                      SBdecomp            zoo
DMCfun                image.binarization  pan                       scales
doc2vec               imager              parallel                  scam
docstring             imagerExtra         parallelDist              scatterpie
[davidg@bunya1 ~]$</code></pre>
</section>
</section>
<section id="access-methods-for-r" class="level3">
<h3 class="anchored" data-anchor-id="access-methods-for-r">Access Methods for R</h3>
<section id="command-line-interactive-batch-job" class="level4">
<h4 class="anchored" data-anchor-id="command-line-interactive-batch-job">Command line interactive batch job</h4>
<ul>
<li>As shown earlier</li>
<li>Command line based</li>
<li>Can be used to launch interactive applications</li>
<li>Key steps
<ul>
<li>Login to the login node</li>
<li><code>salloc ... srun</code> resource request and run shell</li>
<li><code>module load ...</code> activate software</li>
<li>use software</li>
</ul></li>
</ul>
</section>
<section id="regular-batch-jobs" class="level4">
<h4 class="anchored" data-anchor-id="regular-batch-jobs">Regular batch jobs</h4>
<ul>
<li>Create R scripts that are suitable for use on Bunya</li>
<li>Create a <a href="https://github.com/UQ-RCC/hpc-docs/blob/main/guides/Bunya-User-Guide.md#slurm-scripts">batch job script file</a> that will run the job</li>
<li><code>sbatch jobScriptFile</code></li>
</ul>
</section>
<section id="bunya-on-demand" class="level4">
<h4 class="anchored" data-anchor-id="bunya-on-demand">Bunya-on-Demand</h4>
<ul>
<li>Graphical user interface access to Bunya</li>
<li>Accessed via web browser</li>
<li>Select applications from the menus, or</li>
<li>Launch a terminal window
<ul>
<li><code>module load ...</code> to activate the software</li>
<li>start the software</li>
<li><a href="https://github.com/UQ-RCC/hpc-docs/blob/main/guides/OnDemand-Guide.md#rstudio">how it looks for RStudio</a></li>
</ul></li>
</ul>
<hr>
</section>
</section>
<section id="parameter-sweeps" class="level3">
<h3 class="anchored" data-anchor-id="parameter-sweeps">Parameter Sweeps</h3>
<ul>
<li>Often R code is used as part of a parameter sweep study
<ul>
<li>Species of animal/plant/insect</li>
<li>Regions of the globe</li>
<li>Seasons of the year</li>
<li>Climate scenarios of the future</li>
<li><em>even</em> crocodile ID numbers!</li>
</ul></li>
</ul>
<pre><code>#How parameter sweeps get big quickly ... 1,000,000 combinations
for (i in 0:999){
  for (j in 0:99){
    for (k in 0:9){
      do_something(i,j,k)
    }
  }
}</code></pre>
<p>Even if you do this on a Bunya node, using <code>library(parallel)</code>, you can only perform 96 combinations in parallel.</p>
<p>It is often more effective to break it into smaller pieces and use a <em>high throughput computing (HTC)</em> approach. Simplest would look like</p>
<ul>
<li>strip away one of the layers of the nested for loop (e.g.&nbsp;i)</li>
<li>pass i parameter values in as parameters to the R script</li>
<li>use the <code>commandArgs</code> function to accept the value into your code</li>
<li>for each value of i, <code>Rscript scriptName.R i</code></li>
</ul>
<section id="job-arrays" class="level4">
<h4 class="anchored" data-anchor-id="job-arrays">Job Arrays</h4>
<p>Bunya has support for “Job Arrays” which make sweeping over integer parameter values straightforward.</p>
<p>Job arrays can be adapted to sweep non-integer parameters, too.</p>
<p>Job arrays on Bunya are limited to 1,000 elements, but you can submit more than one to the batch system.</p>
</section>
<section id="nimrod" class="level4">
<h4 class="anchored" data-anchor-id="nimrod">Nimrod</h4>
<p>UQ RCC will be adding a tool called Nimrod to Bunya later this year.</p>
<p>That will make it easier to sweeps over combinations of parameters that are not integers.</p>
<p>Nimrod can sweep over parameters values that are</p>
<ul>
<li>floating point values,</li>
<li>sets of character strings,</li>
<li>a list filenames found in a directory,</li>
<li>etc.</li>
</ul>
</section>
</section>
</section>
<section id="in-summary" class="level2">
<h2 class="anchored" data-anchor-id="in-summary">In summary</h2>
<p><em>The possibilities that arise from combining R with HPC are well worth the learning curve!</em></p>
<hr>
<p>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>